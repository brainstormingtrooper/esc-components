<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../paper-input/paper-input.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-icons/maps-icons.html">

<link rel="import" href="../esc-action/esc-action.html">

<dom-module id="esc-simpleitemvenda">
	<template>
		<style>
			:host {
				display: block;
				width: 100%;
				height: 100px;
				background-color: var(--primary-background, #FFFFFF);
				padding-top: 5px;
				padding-bottom: 5px;
				border-bottom: 1px solid #CECECE;
    			padding-top: 15px;
    			padding-bottom: 15px;

			}
			:host:last-child, :host:nth-last-child(2){
				border-bottom: 0px;
			}
			.detalhes{
				width: calc(100% - 110px);
				height: 100px;
				display: inline-block;
				border-right: 1px solid #CECECE;
			}
			.field{
				width: 100%;
				height: 32px;
				margin-top: 1px;
				white-space: nowrap;
				overflow-y: hidden;
				overflow-x: scroll;
			}
			.fieldVenda{
				width: 100%;
				height: 32px;
				margin-top: 1px;
				overflow: hidden;

			}
			.detalhes > .nome{
				line-height: 32px;
				text-indent: 5px;
				font-size: 1.1em;
			}
			.detalhes > .descricao{
				line-height: 32px;
				text-indent: 5px;
				font-size: 0.9em;
			}
			.detalhes > .acoes{
			}
			.noSale{
		    	width: 100%;
				border: 0px;
		    }
			.acoes > .acao{
				width: 32px;
				height: 32px;
				display: inline-block;
				border-radius: 50%;
				margin-left: 5px;

			}
			.acoes > .acao:active{
				background-color: #d8d8d8;
			}
			.acao > img{
			    width: 23px;
			    height: 23px;
			    display: block;
			    margin: auto;
			    margin-top: 6px;
			    color: #4d4d4d;
			}
			.acao > iron-icon{
			    width: 23px;
			    height: 23px;
			    display: block;
			    margin: auto;
			    margin-top: 6px;
			    color: #4d4d4d;
			}
			.acoes > .acaoVenda{
				width: 50%;
				height: 100%;
				float: left;
				background-color: #555753;
			}
			.acoes > .adicionar{
				background-color: #7CB342;
			}
			.acoes > .adicionar:active{
				background-color: #689F38;
			}
			.acoes > .remover{
				background-color: #CECECE;
			}
			.acoes > .remover:active{
				background-color: #BABDB6;
			}
			.vendaItem{
				width: 100px;
				height: 100px;
				display: inline-block;
				margin-left: 2px;
			}
			.vendaItem > .preco{
				line-height: 32px;
				text-indent: 5px;
			}
			.vendaItem > .quantidade{
				line-height: 32px;
				text-indent: 5px;
				font-size: 0.9em;
			}
			.vendaItem > .acoes{
			}
			.input{
				width: 75px;
			    height: 24px;
			    float: right;
			    border: 0px;
			    font-size: 1.1em;
			    border-bottom: 1px solid #CECECE;

			}
			.input:disabled{
				background-color: #FFF;
			}
			.fieldVenda > .icon{
				width: 20px;
				margin-top: 2px;
				margin-left: 0px;
				float: left;
			}

			.acaoVenda > .icon{
				width: 25px;
				height: 32px;
				display: block;
				margin: auto;
			}

			.paper-radio-button {
				padding: 6px 12px 6px 12px;
			}

			.paper-input{
				padding: 0px 12px 0px 12px;
			}


			/*Css paper dialog*/
			.paper-dialog{
				width: 80%;
				max-height: 70%;
				margin: auto;
				z-index: 120 !important;
			}


			.paper-dialog > .header{
				width: 100%;
				box-sizing: border-box;
				margin-top: 0px;
				text-align: center;

			}
			.header > .title{
				float: left;
				text-align: center;
				width: calc(100% - 24px);
				font-size: 1.4em;
				padding-top: 15px;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.icon-close{
				float: right;
				transform: translateX(10px);
				color: red;
				margin-top: 10px;
			}
			.clear{
				clear: both;
			}

			.paper-dialog > .buttons{
				color: #FFF;
				padding: 8px;
			}

			.paper-dialog > .buttons > .botaoConfirmarModal{
				background-color: #1976d2;
				width: 50%;
			}
			.paper-dialog > .buttons > .botaoConfirmarModalGrande{
				background-color: #1976d2;
				width: 100%;
			}
			.paper-dialog > .buttons > .botaoCancelarModal{
				background-color: #FF5050;
				width: 50%;
			}

			@media screen and (min-width: 600px){
				.paper-dialog{
					width: 400px;
				}
			}
			.content{
				width: 100%;
				height: 40vh;
				box-sizing: border-box;
				position: relative;
				margin: auto;
				padding: 20px 20px 10px 20px;
				overflow-y: scroll;

			}
			.textarea{
				height: 30vh;
				width: 98%;
				resize: none;
				position: relative;
				margin: auto;
			}
			.textarea:focus{
				outline: none;
			}
			@media screen and (max-height: 500px){
				.textarea{
					height: 25vh;
				}
				.content{
					height: 35vh;
				}
				.content-maior{
					height: 40vh !important;
				}
			}

			.text{
		        font-size: 1.1em;
		    }

		    .info{
		        font-size: 1.1em;
		        color: #444444;
		    }

		    .radio-valor{
		    	padding-bottom: 15px;
		    }

		    .precoPrincipal{
		    	border-bottom: 1px solid #cecece !important;
			    width: -8px;
			    margin-top: 0px;
			    top: 0px;
			    width: 75px;
			    float: right;
			    height: 29px;
			    text-indent: 0px;
		    }
		    .precoUnitario{
		    	background-color: #7cb342;
			    color: #FFF;
			    padding: 3px 5px 3px 5px;
		    }


		</style>

		<paper-dialog id="modalObservacao" class="paper-dialog">
			<div class="header">
				<div class="title">Observação - [[nome]]</div>
		  		<iron-icon class="icon-close" on-click="_closeModalObservacao" icon="icons:close"></iron-icon>
		  		<div class="clear"></div>
			</div>

		  	<div class="content">
		  		<textarea id="textAreaObservacao" value="{{observacao}}" on-keyup="_setValueObservacao" class="textarea"></textarea>
		  	</div>

		  	<div class="buttons">
		  		<paper-button class="botaoCancelarModal" raised on-click="_limparObservacao" >Limpar</paper-button>
		    	<paper-button class="botaoConfirmarModal" raised dialog-confirm autofocus>Ok</paper-button>
		 	</div>
		</paper-dialog>


		<div id="detalhesItem" class="detalhes">
			<div class="field nome">[[nome]]</div>
			<div class="field descricao">
				<span class="precoUnitario">Und. R$ [[_showValorUnitario(preco)]]</span>
				<span>[[descricao]] </span>

			</div>
			<div class="field acoes">
				<template is="dom-if" if="{{!withoutObservacao}}">
					<esc-action id="observacaoItem" on-click="_openModalObservacao" icon="../../bower_components/esc-components/esc-simpleitemvenda/icons/ic_assignment_black_24px.svg" filled="[[observacao]]"></esc-action>
				</template>
			</div>
		</div>
		<div id="vendaItem" class="vendaItem">

			<div class="fieldVenda preco">
				<img class="icon" src="bower_components/esc-components/esc-simpleitemvenda/icons/ic_attach_money_black_24px.svg">
				<div id="preco" class="precoPrincipal">[[_showValorTotalVenda(preco, quantidade)]]</div>
			</div>
			<div class="fieldVenda quantidade">
				<img class="icon" src="bower_components/esc-components/esc-simpleitemvenda/icons/ic_add_shopping_cart_black_24px.svg">
				<input id="quantidade" class="input" type="number" name="" on-keyup="_setValuePress" value="{{quantidade}}">
			</div>
			<div class="fieldVenda acoes">
				<div class="acaoVenda remover" on-click="_removerUm">
					<img class="icon" src="bower_components/esc-components/esc-simpleitemvenda/icons/ic_remove_white_24px.svg">
				</div>
				<div class="acaoVenda adicionar" on-click="_adicionarUm">
					<img class="icon" src="bower_components/esc-components/esc-simpleitemvenda/icons/ic_add_white_24px.svg">
				</div>
			</div>

		</div>

	</template>
	<script>
    	class EscSimpleitemvenda extends Polymer.Element {
      		static get is() { return "esc-simpleitemvenda"; }
      		static get properties() {
      	    	return {
      	    		id: {
						type: Number,
						notify: true,
					},
					nome: {
						type: String,
						value: "Produto"
					},
					descricao: {
						type: String
					},
					preco: {
						type: Number,
						notify: true,
						value: 0,
						observer: '_propagateChangeEvent'
					},
					quantidade: {
						type: Number,
						notify: true,
						value: 0,
						observer: '_propagateChangeEvent'
					},
					observacao:{
						type: String,
						notify: true,
						observer: '_propagateChangeEvent'
					},
					withoutObservacao:{
						type: Boolean,
						value: false
					},
					noSale:{
						type: Boolean,
						value: false
					}
          		}
      		}


			ready(){
				super.ready();

				if(this.noSale){
					this.$.vendaItem.hidden = true;
					this.$.detalhesItem.classList.add('noSale');
					this.$.observacaoItem.hidden = true;
				}
			}

			connectedCallback(){
				super.connectedCallback();
					if(!this.quantidade)
						this.quantidade = 0;

			}

			_calculaValorTotalVenda(valor, quantidade){

				let resultado = valor * quantidade;

				return this._formatarPreco(isNaN(resultado) ? 0 : resultado);

			}

			_showValorUnitario(preco){
				return this._formatarPreco(preco);
			}

			_showValorTotalVenda(preco, quantidade){

				let resultado = preco * quantidade

				return this._formatarPreco(resultado);
			}

			_formatarPreco(valor){

				if(typeof valor === 'string')
					valor = valor.replace(',','.');

				let valorNumber = parseFloat(valor);

				return VMasker.toMoney(valorNumber.toFixed(2));
			}

			_getDateToday(){
				let d = new Date();
		        let month = '' + (d.getMonth() + 1);
		        let day = '' + d.getDate();
		        let year = d.getFullYear();

		    	if (month.length < 2) month = '0' + month;
		    	if (day.length < 2) day = '0' + day;

		    	return [year, month, day].join('-');
			}

			_propagateChangeEvent(){
				if(this.quantidade !== undefined || this.preco !== undefined || this.observacao !== undefined){
					var event = new Event('venda');
					this.dispatchEvent(event);
				}
			}

			_setValuePress(event){
				let value = parseInt(this.$.quantidade.value);

				if(isNaN(value)){
					this.$.quantidade.value = 0;
					this.quantidade = 0;
				}else{
					this.quantidade = value;
				}

				this._propagateChangeEvent();
			}

			_setValueObservacao(){
				this.observacao = this.$.textAreaObservacao.value;
			}

			_limparObservacao(){
				this.observacao = "";

				setTimeout(()=>{
					this.$.textAreaObservacao.focus();
				}, 10)
			}

			_openModalObservacao(){
				this.$.modalObservacao.open();
				setTimeout(()=>{
					this.$.textAreaObservacao.focus();
				}, 10);
			}

			_closeModalObservacao(){
				this.$.modalObservacao.close();
			}

			_adicionarUm(){
				this.quantidade++;
				this._propagateChangeEvent();
			}

			_removerUm(){
				if(this.quantidade > 0){
					this.quantidade--;
					this._propagateChangeEvent();
				}
			}

			getQuantidade(){
				return this.quantidade;
			}

			getId(){
				return this.id;
			}

    	}
    	window.customElements.define(EscSimpleitemvenda.is, EscSimpleitemvenda);
  	</script>

</dom-module>
